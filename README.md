# AVRCP

[![License: AGPL v3](https://img.shields.io/badge/License-AGPL%20v3-blue.svg)](https://www.gnu.org/licenses/agpl-3.0)

이 애플리케이션은 아이나비 X1 오디오 컨트롤러 기반의 Android 앱으로, 차량 스티어링 휠 버튼을 통해 음악 재생을 제어하고, Apple CarPlay 어댑터(AutoKit)와 연동하여 기능을 확장합니다.

## 목차

* [개요](#개요)
* [주요 기능](#주요-기능)
* [설치 및 사용](#설치-및-사용)
* [AutoKit 연동](#autokit-연동)
* [라이선스](#라이선스)
* [크레딧](#크레딧)

## 개요

### 동작 조건

* **(필수)아이나비 정품 Trip 컴퓨터**: 아이나비 정품 트립 컴퓨터 및 정품 트립 앱에서만 정상 동작합니다.
* **테스트 환경**: 본 앱은 Android 4.4 OS가 탑재된 아이나비 M300 디바이스에서 테스트되었습니다.
* **기타 디바이스**: 다른 디바이스나 비정품 Trip 시스템에서는 정상 동작을 보장하지 않습니다.

## 주요 기능

### 원본 기능

1. 시동 후 자동 음악 재생
2. 블루투스 통화 시 음악 자동 일시 정지
3. 내비게이션 음성 안내 시 자동 볼륨 조절
4. 내비게이션 화면 내 오디오 컨트롤바
5. 전체 화면 플로팅 오디오 컨트롤바
6. 핸들 SEEK 키를 통한 음악 앱 및 내비게이션 앱 실행
7. 핸들 키를 통한 곡 넘김, 재생, 일시 정지
8. SEEK 키 다중 클릭(2회, 3회)을 통한 사용자 정의 앱 실행

### 추가 기능

#### AutoKit (Apple CarPlay) 연동

Carlinkit 사의 Apple CarPlay 어댑터와 연동하여 차량 스티어링 휠 리모컨 제어를 지원합니다. AutoKit 앱은 하드웨어 버튼 매핑 방식을 사용하며, 그 외의 음악 앱들은 기존과 동일하게 브로드캐스트 방식으로 제어됩니다.

#### 아이나비 Trip 앱 자동 실행

AutoKit 앱 설치 시 발생하는 아이나비 Trip 앱의 간헐적 실행 실패 문제를 해결합니다. AVRCP 구동 후 10초 이내에 Trip 앱이 실행되지 않으면 자동으로 실행됩니다.

## 수정 배경

### AutoKit Intent 수신 문제

원래 이벤트 전달 방식은 브로드캐스트 Intent를 사용했으나, AutoKit 2023년 버전부터 외부 Media Intent 수신을 차단하기 위해 `exported="false"`로 변경되었습니다. 2024년 버전부터는 앱 변조 방지 메커니즘으로 인해 `AndroidManifest.xml` 수정을 할 수 없습니다.

이 문제를 해결하기 위해, AutoKit의 고급 설정에서 제공하는 하드웨어 버튼 매핑 기능을 활용했습니다. 본 앱의 음악 앱 선택 메뉴에서 AutoKit을 선택하면 하드웨어 버튼 매핑 방식으로 동작하며, 다른 음악 앱들은 기존 브로드캐스트 방식으로 제어됩니다.

## 설치 및 사용

### 다운로드

1. [Releases 페이지](https://github.com/itswryu/avrcp-release/releases)에서 최신 버전의 APK 파일을 다운로드합니다.
2. Android 기기에 APK를 설치합니다.
3. 필수 권한을 허용합니다.

### 필수 권한

* 미디어 제어 권한
* 오디오 포커스 제어
* 접근성 서비스 (플로팅 컨트롤바 사용 시)
* 자동 실행 권한 (제조사별 설정 필요)

### 기본 설정

1. AVRCP 앱을 실행합니다.
2. 설정 메뉴에서 음악 앱을 선택합니다.
3. 필요에 따라 핸들 버튼 매핑을 설정합니다.
4. 플로팅 컨트롤바를 활성화합니다 (선택 사항).

## AutoKit 연동

### 설정

1. AVRCP 앱을 실행합니다.
2. 음악 앱을 선택합니다.
3. AutoKit을 선택합니다.
4. '시작'을 선택합니다.

### 지원 명령

* 재생/일시 정지: 핸들 SEEK UP 버튼 더블 클릭
* 다음 곡: 핸들 SEEK UP 버튼
* 이전 곡: 핸들 SEEK DOWN 버튼

### 참고 사항

AutoKit 앱은 하드웨어 버튼 매핑 방식을 사용하며, 미디어 제어 표준 버튼을 지원하므로 AutoKit 앱 내에서 추가 설정이 불필요합니다. 다른 음악 앱(예: 멜론, 유튜브 뮤직 등)은 기존 브로드캐스트 방식으로 제어되므로 동일하게 사용할 수 있습니다.

## 크레딧

본 프로젝트는 [지이](https://blog.naver.com/ji2soft)님의 원본 프로젝트를 기반으로 개발되었습니다.

원본 프로젝트의 소스 코드를 제공해주신 지이님께 감사드립니다.# 문의

버그 리포트 및 기능 요청은 [GitHub Issues](https://github.com/itswryu/new-avrcp/issues)를 이용해 주세요.
